{% extends 'layout/base.html' %}
{% block title %}Lập hóa đơn{% endblock %}
<body>
{% block content %}
<form>
    <div class="row">
        {% for rf in rp_f %}
        <div class="col-md-6 mb-4">
            <div class="card repair-card">

                <!-- HEADER -->
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <div>
                        <i class="bi bi-receipt"></i>
                        <strong class="ms-1">Phiếu sửa #{{ rf.id }}</strong>
                    </div>

                    {% if rf.status == 'DONE' %}

                    {% else %}

                    {% endif %}
                     <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> Đã sửa xong
                     </span>
<!--                    <span class="badge bg-warning text-dark">-->
<!--                    <i class="bi bi-tools"></i> Đang sửa-->
<!--                    </span>-->
                </div>

                <!-- BODY -->
                <div class="card-body">

                    <div class="row">
                        <!-- LEFT -->
                        <div class="col-md-6">
                            <p class="info-item mb-2">
                                <i class="bi bi-person"></i>
                                <strong>Khách : </strong> {{ rf.reception_form.name }}
                            </p>
                            <p class="info-item mb-2">
                                <i class="bi bi-telephone"></i>
                                <strong>SĐT : </strong>{{ rf.reception_form.phonenumber }}
                            </p>
                            <p class="info-item mb-2">
                                <i class="bi bi-car-front"></i>
                                <strong>Biển số : </strong>{{ rf.reception_form.carnumber }}
                            </p>
                        </div>

                        <!-- RIGHT -->
                        <div class="col-md-6">
                            <p class="info-item mb-2">
                                <i class="bi bi-exclamation-circle"></i>
                                <strong>Lỗi : </strong> {{ rf.reception_form.description }}
                            </p>
                            <p class="info-item mb-2">
                                <i class="bi bi-person-gear"></i>
                                <strong>KTV tiếp nhận : </strong>{{ rf.technick.name }}
                            </p>
                        </div>
                    </div>

                    <hr>

                    <!-- MONEY -->
                    <div class="row g-2">
                        <div class="col-4">
                            <div class="money-box">
                                <div class="text-muted small">Công sửa</div>
                                <strong>{{ rf.total_labor_cost }}</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="money-box">
                                <div class="text-muted small">Linh kiện</div>
                                <strong>{{ rf.total_component_cost }}</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="money-box total">
                                <div class="text-muted small">Tổng</div>
                                <strong class="text-danger fs-5">
                                    {{ rf.total_cost }}
                                </strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div>
                        <input type="checkbox"
                               name="repair_form_ids"
                               value="{{ rf.id }}">
                        <span class="ms-1">Lập hóa đơn</span>
                    </div>

                    <button type="button"
                            class="btn btn-sm btn-info"
                            onclick="toggleDetail({{ rf.id }}, this)">
                        Chi tiết
                    </button>
                </div>

                <!-- DETAIL -->
                <div id="detail-{{ rf.id }}" class="card-body border-top" style="display: none;">
                    {% for action in rf.actions %}
                    <div class="mb-3">
                        <div class="fw-bold text-primary">
                            {{ action.description }}
                            <span class="text-muted small">(Công: {{ action.labor_cost }})</span>
                        </div>

                        <table class="table table-sm table-bordered mt-2">
                            <colgroup>
                                <col style="width: 40%">
                                <col style="width: 20%">
                                <col style="width: 20%">
                                <col style="width: 20%">
                            </colgroup>
                            <thead class="table-light">
                            <tr>
                                <th>Linh kiện</th>
                                <th class="text-end">Giá</th>
                                <th class="text-end">SL</th>
                                <th class="text-end">Thành tiền</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for ac in action.components %}
                            <tr>
                                <td>{{ ac.component.name }}</td>
                                <td class="text-end">{{ ac.component.price }}</td>
                                <td class="text-end">{{ ac.quantity }}</td>
                                <td class="text-end">
                                    {{ ac.component.price * ac.quantity }}
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                </div>

            </div>
        </div>

        {% endfor %}
    </div>

    <button type="submit" class="btn btn-success mt-3">
        Lập hóa đơn
    </button>
</form>
<script>
    function toggleDetail(id, btn) {
        const row = document.getElementById("detail-" + id);

        if (row.style.display === "none" || row.style.display === "") {
            row.style.display = "table-row";
            btn.innerText = "Ẩn";
            btn.classList.remove("btn-info");
            btn.classList.add("btn-secondary");
        } else {
            row.style.display = "none";
            btn.innerText = "Chi tiết";
            btn.classList.remove("btn-secondary");
            btn.classList.add("btn-info");
        }
    }

</script>
{% endblock %}
</body>
