{% extends 'layout/base.html' %}

{% block content %}
    <style>
        .form_receptions {
            margin-top: 20px;
        }

        /* USER LIST TABLE */
        .form_receptions .user-list tbody td > img {
            position: relative;
            max-width: 50px;
            float: left;
            margin-right: 15px;
        }

        .form_receptions .user-list tbody td .user-link {
            display: block;
            font-size: 1.25em;
            padding-top: 3px;
            margin-left: 60px;
        }

        .form_receptions .user-list tbody td .user-subhead {
            font-size: 0.875em;
            font-style: italic;
        }

        /* TABLES */
        .form_receptions .table {
            border-collapse: separate;
        }

        .form_receptions .table-hover > tbody > tr:hover > td,
        .form_receptions .table-hover > tbody > tr:hover > th {
            background-color: #eee;
        }

        .form_receptions .table thead > tr > th {
            border-bottom: 1px solid #C2C2C2;
            padding-bottom: 0;
        }

        .form_receptions .table tbody > tr > td {
            font-size: 0.875em;
            background: #f5f5f5;
            border-top: 10px solid #fff;
            vertical-align: middle;
            padding: 12px 8px;
        }

        .form_receptions .table tbody > tr > td:first-child,
        .form_receptions .table thead > tr > th:first-child {
            padding-left: 20px;
        }

        .form_receptions .table thead > tr > th span {
            border-bottom: 2px solid #C2C2C2;
            display: inline-block;
            padding: 0 5px;
            padding-bottom: 5px;
            font-weight: normal;
        }

        .form_receptions .table a.table-link {
            margin: 0 5px;
            font-size: 1.125em;
        }

        .form_receptions .table a.table-link:hover {
            text-decoration: none;
            color: #2aa493;
        }

        .form_receptions .label {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .form_receptions .label-default {
            background-color: #6c757d;
            color: #fff;
        }

        .form_receptions .label-success {
            background-color: #28a745;
            color: #fff;
        }

        .form_receptions .label-danger {
            background-color: #dc3545;
            color: #fff;
        }

        .form_receptions .label-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .form_receptions .main-box {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .form_receptions .pagination {
            justify-content: flex-end;
        }

        /* MODAL STYLES */
        .modal-wrapper {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-wrapper.active {
            display: flex;
        }

        .modal-body {
            background: white;
            width: 95%;
            max-width: 1100px;
            min-height: 75vh;
            max-height: 95vh;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 3px solid #333;
        }

        .modal-header {
            position: relative;
            padding: 20px;
            border-bottom: 3px solid #333;
            text-align: center;
        }

        .modal-header h3 {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 32px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            border: none;
            background: none;
        }

        .close:hover {
            color: #e74c3c;
        }

        .modal-info {
            padding: 15px 20px;
            background: #f9f9f9;
            border-bottom: 3px solid #333;
            text-align: center;
            line-height: 1.8;
        }

        .modal-info strong {
            font-weight: 600;
        }

        .modal-content {
            padding: 20px;
        }

        /* Items Container */
        .items-container {
            margin-bottom: 20px;
        }

        .repair-item {
            border: 3px solid #333;
            background: white;
            margin-bottom: 15px;
            position: relative;
            padding: 15px;
        }

        .repair-item:last-child {
            margin-bottom: 0;
        }

        /* Row với các trường input */
        .item-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .item-row input {
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 4px;
            font-size: 14px;
        }

        .item-row input:nth-child(1) {
            width: 25%;
        }

        .item-row input:nth-child(2) {
            width: 10%;
        }

        /* Search Input Container */
        .search-container {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .search-container > .search-input {
            width: 100% !important;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        /* Search Dropdown Panel */
        .search-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 3px solid #333;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 100;
            max-height: 300px;
            min-width: 380px;
            overflow-y: auto;
        }

        .search-dropdown.active {
            display: block;
        }

        /* Filter Row */
        .search-filters {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-bottom: 2px solid #333;
            background: #f9f9f9;
            align-items: center;
        }

        .search-filters select {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #333;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .search-filters button {
            padding: 6px 20px;
            border: 2px solid #333;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .search-filters button:hover {
            background: #333;
            color: white;
        }

        /* Search Results List */
        .search-results {
            padding: 10px;
        }

        .search-result-item {
            padding: 10px;
            border: 2px solid #333;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:last-child {
            margin-bottom: 0;
        }

        .search-result-item:hover {
            background: #f0f0f0;
        }

        .search-result-name {
            font-weight: 600;
            flex: 1;
        }

        .search-result-price {
            color: #e74c3c;
            font-weight: 600;
            margin-left: 15px;
        }

        .item-row input:nth-child(4),
        .item-row input:nth-child(5) {
            width: 120px;
        }

        .delete-item {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .delete-item:hover {
            background: #c0392b;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn-primary {
            padding: 12px 40px;
            border: 2px solid #333;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #333;
            color: white;
        }

        .no-results {
            padding: 15px;
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>

    <div class="form_receptions">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="main-box clearfix">
                        <div class="table-responsive">
                            <table class="table user-list table-hover">
                                <thead>
                                <tr>
                                    <th><span>Người dùng</span></th>
                                    <th><span>Ngày sửa</span></th>
                                    <th class="text-center"><span>Trạng thái</span></th>
                                    <th><span>Số điện thoại</span></th>
                                    <th><span>Biển số xe</span></th>
                                    <th>&nbsp;</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr data-receptionform-id="1">
                                    <td class="info">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="">
                                        <a href="#" class="user-link">Mila Kunis</a>
                                        <span class="user-subhead">Admin</span>
                                    </td>
                                    <td class="date">2013/08/08</td>
                                    <td class="state text-center">
                                        <span class="label label-default">Inactive</span>
                                    </td>
                                    <td class="phone_number">0935345345</td>
                                    <td class="car_number">72-F0993945</td>
                                    <td style="width: 20%;">
                                        <a href="#" class="open-modal table-link">
                                            <span class="button button__link fa-stack">
                                                <i class="fa fa-square fa-stack-2x"></i>
                                                <i class="fa fa-pencil fa-stack-1x fa-inverse"></i>
                                            </span>
                                        </a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav>
                            <ul class="pagination">
                                <li class="page-item"><a class="page-link" href="#"><i class="fa fa-chevron-left"></i></a></li>
                                <li class="page-item"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item"><a class="page-link" href="#">4</a></li>
                                <li class="page-item"><a class="page-link" href="#">5</a></li>
                                <li class="page-item"><a class="page-link" href="#"><i class="fa fa-chevron-right"></i></a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal-wrapper" id="modal">
            <div class="modal-body">
                <div class="modal-header">
                    <h3>PHIẾU SỬA XE</h3>
                    <a href="#" class="close">&times;</a>
                </div>

                <div class="modal-info">
                    <strong>Họ tên:</strong> <span id="modal_name"></span> &nbsp;&nbsp;|&nbsp;&nbsp;
                    <strong>Số điện thoại:</strong> <span id="modal_phone"></span> &nbsp;&nbsp;|&nbsp;&nbsp;
                    <strong>Biển số xe:</strong> <span id="modal_car"></span>
                </div>

                <form id="repair-form" method="POST">
                    <!-- Hidden input cho receptionform_id -->
                    <input type="hidden" id="receptionform_id" name="receptionform_id">

                    <div class="modal-content">
                        <!-- Items Container -->
                        <div class="items-container" id="items-container">
                            <!-- Dòng đầu tiên -->
                            <div class="repair-item">
                                <div class="item-row">
                                    <input name="items[0][action]" type="text" placeholder="Lỗi" class="error-input" required>
                                    <input name="items[0][cost]" type="text" placeholder="Tiền công" class="labor-input" required>

                                    <!-- Search Container với Dropdown -->
                                    <div class="search-container">
                                        <input type="text" placeholder="Tìm linh kiện..." class="search-input" required>
                                        <!-- Hidden input cho component_id -->
                                        <input type="hidden" name="items[0][component_id]" class="component-id-input" required>
                                        <div class="search-dropdown">
                                            <!-- Filter Row -->
                                            <div class="search-filters">
                                                <select class="vehicle-brand">
                                                    <option value="">Hãng xe</option>
                                                    {% for brand in brands %}
                                                        <option value="{{ brand.id }}">{{ brand.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <select class="vehicle-type">
                                                    <option value="">Loại xe</option>
                                                    {% for vehicle in vehicles %}
                                                        <option value="{{ vehicle.id }}">{{ vehicle.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <button type="button" class="btn-apply-filter">Lọc</button>
                                            </div>
                                            <div class="search-results"></div>
                                        </div>
                                    </div>

                                    <input name="items[0][quantity]" type="text" placeholder="Số lượng" class="quantity-input" required>
                                    <input type="text" placeholder="Tiền linh kiện" class="part-price-input" readonly required>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="button" class="btn-primary" id="add-items">Thêm dòng</button>
                            <button type="submit" class="btn-primary" id="confirm-btn">Xác nhận</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA FROM BACKEND ====================
        const componentsData = {{ comps | tojson | safe }};
        const itemsContainer = document.getElementById('items-container');
        const itemTemplate = itemsContainer.querySelector('.repair-item').cloneNode(true);

        // ==================== MODAL CONTROLS ====================
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.querySelectorAll('.open-modal').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const tr = this.closest('tr');

                // Hiển thị thông tin
                document.getElementById('modal_name').textContent = tr.querySelector('.user-link').textContent;
                document.getElementById('modal_phone').textContent = tr.querySelector('.phone_number').textContent;
                document.getElementById('modal_car').textContent = tr.querySelector('.car_number').textContent;

                // Lấy receptionform_id từ data attribute
                const receptionformId = tr.getAttribute('data-receptionform-id');
                document.getElementById('receptionform_id').value = receptionformId;

                // Bật modal
                document.getElementById('modal').classList.add('active');
            });
        });

        document.querySelector('.close').addEventListener('click', function(e) {
            e.preventDefault();
            closeModal();
            resetItems();
        });

        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.querySelector('.modal-body').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('modal').classList.contains('active')) {
                closeModal();
            }
        });

        // ==================== SEARCH FUNCTIONALITY ====================
        function attachSearchEvents(item) {
            const searchInput = item.querySelector('.search-input');
            const dropdown = item.querySelector('.search-dropdown');
            const resultsContainer = item.querySelector('.search-results');
            const vehicleBrand = item.querySelector('.vehicle-brand');
            const vehicleType = item.querySelector('.vehicle-type');
            const applyFilterBtn = item.querySelector('.btn-apply-filter');
            const componentIdInput = item.querySelector('.component-id-input');

            let currentFilter = {
                brand_id: '',
                vehicle_id: ''
            };

            // Mở dropdown khi click vào search
            searchInput.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.add('active');
                performSearch();
            });

            // Tìm kiếm khi gõ
            searchInput.addEventListener('input', function() {
                performSearch();
            });

            // Apply filter khi click nút Lọc
            applyFilterBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                currentFilter.brand_id = vehicleBrand.value;
                currentFilter.vehicle_id = vehicleType.value;
                performSearch();
            });

            // Reset filter khi thay đổi select
            vehicleBrand.addEventListener('change', function() {
                currentFilter.brand_id = '';
            });

            vehicleType.addEventListener('change', function() {
                currentFilter.vehicle_id = '';
            });

            // Thực hiện tìm kiếm
            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                let results = [...componentsData];

                // Filter by brand_id
                if (currentFilter.brand_id) {
                    results = results.filter(comp =>
                        String(comp.brand_id) === String(currentFilter.brand_id)
                    );
                }

                // Filter by vehicle_id
                if (currentFilter.vehicle_id) {
                    results = results.filter(comp =>
                        String(comp.vehicle_id) === String(currentFilter.vehicle_id)
                    );
                }

                // Search by name
                if (searchTerm) {
                    results = results.filter(comp =>
                        comp.name.toLowerCase().includes(searchTerm)
                    );
                }

                displayResults(results);
            }

            // Hiển thị kết quả
            function displayResults(results) {
                resultsContainer.innerHTML = '';

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">Không tìm thấy linh kiện</div>';
                    return;
                }

                results.forEach(comp => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';

                    const price = parseFloat(comp.price || 0);
                    const formattedPrice = price.toLocaleString('vi-VN');

                    resultItem.innerHTML = `
                        <span class="search-result-name">${comp.name}</span>
                        <span class="search-result-price">${formattedPrice}đ</span>
                    `;

                    // Click để chọn
                    resultItem.addEventListener('click', function() {
                        searchInput.value = comp.name;

                        // Lưu component_id vào hidden input
                        if (componentIdInput) {
                            componentIdInput.value = comp.id;
                        }

                        item.querySelector('.part-price-input').value = price;
                        dropdown.classList.remove('active');
                    });

                    resultsContainer.appendChild(resultItem);
                });
            }
        }

        // Đóng dropdown khi click ra ngoài
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.querySelectorAll('.search-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });

        // ==================== ITEM MANAGEMENT ====================
        function attachDeleteEvent(item) {
            const deleteBtn = item.querySelector('.delete-item');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    if (document.querySelectorAll('.repair-item').length > 1) {
                        item.remove();
                    } else {
                        alert('Phải có ít nhất một dòng!');
                    }
                });
            }
        }

        function resetItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            const newItem = itemTemplate.cloneNode(true);

            newItem.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.removeAttribute('data-comp-id');
            });

            newItem.querySelectorAll('select').forEach(select => {
                select.value = '';
            });

            const results = newItem.querySelector('.search-results');
            if (results) results.innerHTML = '';

            container.appendChild(newItem);

            attachDeleteEvent(newItem);
            attachSearchEvents(newItem);
        }

        // Thêm dòng mới
        document.getElementById('add-items').addEventListener('click', function() {
            const container = document.getElementById('items-container');
            const currentItemCount = container.querySelectorAll('.repair-item').length;
            const newItem = document.createElement('div');
            newItem.className = 'repair-item';

            newItem.innerHTML = `
                <button type="button" class="delete-item">×</button>
                <div class="item-row">
                    <input name="items[${currentItemCount}][action]" type="text" placeholder="Lỗi" class="error-input" required>
                    <input name="items[${currentItemCount}][cost]" type="text" placeholder="Tiền công" class="labor-input" required>
                    <div class="search-container">
                        <input type="text" placeholder="Tìm linh kiện..." class="search-input" required>
                        <input type="hidden" name="items[${currentItemCount}][component_id]" class="component-id-input" required>
                        <div class="search-dropdown">
                            <div class="search-filters">
                                <select class="vehicle-brand">
                                    <option value="">Hãng xe</option>
                                    {% for brand in brands %}
                                        <option value="{{ brand.id }}">{{ brand.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="vehicle-type">
                                    <option value="">Loại xe</option>
                                    {% for vehicle in vehicles %}
                                        <option value="{{ vehicle.id }}">{{ vehicle.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn-apply-filter">Lọc</button>
                            </div>
                            <div class="search-results"></div>
                        </div>
                    </div>
                    <input name="items[${currentItemCount}][quantity]" type="text" placeholder="Số lượng" class="quantity-input" required>
                    <input type="text" placeholder="Tiền linh kiện" class="part-price-input" readonly required>
                </div>
            `;

            container.appendChild(newItem);
            attachDeleteEvent(newItem);
            attachSearchEvents(newItem);
        });

        // Khởi tạo items hiện có
        document.querySelectorAll('.repair-item').forEach(item => {
            attachDeleteEvent(item);
            attachSearchEvents(item);
        });

        // ==================== FORM SUBMISSION ====================

    </script>
{% endblock %}